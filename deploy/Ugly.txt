<!DOCTYPE html>
<html>
<head>
    <title>Requirements Traceability Matrix</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Fri Apr 14 2017 15:58:32 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Fri Apr 14 2017 15:58:32 GMT-0600 (MDT)";
        var STORY    = "F260";
        var BUILDER  = "corkr03";
        var CHECKSUM = 11274998312;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("RallyTechServices.RequirementsTracabilityMatrix.utils.exportConfiguration",{initiativeObjectID:null,portfolioItemTypes:null,extractFields:null,constructor:function(a){this.portfolioItemTypes=a.portfolioItemTypes,this.initiativeObjectID=a.initiativeObjectID,this.extractFields=a.extractFields},transformRecordsToExtract:function(a,b,c,d){for(var e={},f=0;f<a.length;f++)e[a[f].get("ObjectID")]=a[f].getData();for(var g={},f=0;f<b.length;f++)g[b[f].get("ObjectID")]=b[f].getData(),b[f].Parent&&(b[f].Parent=e[b[f].Parent.ObjectID]);for(var h={},f=0;f<d.length;f++){var i=d[f].get("WorkProduct")&&d[f].get("WorkProduct").ObjectID;h[i]||(h[i]=[]),h[i].push(d[f].getData())}for(var j=[],k=[],l=0;l<this.extractFields.length;l++)k.push(this.scrubCell(this.extractFields[l].text));j.push(k.join(","));for(var m=0;m<c.length;m++){var n=c[m].getData();n.TestCases=h[n.ObjectID],n.Feature=n.Feature&&g[n.Feature.ObjectID]||null,n.Initiative=n.Feature&&n.Feature.Parent||null;for(var k=[],l=0;l<this.extractFields.length;l++){var o=this.extractFields[l];k.push(this.getCellData(o,n,e,g,h))}j.push(k.join(","))}return j.join("\r\n")},scrubCell:function(a){var b=new RegExp(',|"|\r|\n',"g"),c=new RegExp("</?[^>]+>","g"),d=new RegExp("&nbsp;","ig");return/<br\s?\/?>/.test(a)&&(a=a.replace(/<br\s?\/?>/g,"\n")),c.test(a)&&(a=Ext.util.Format.htmlDecode(a),a=Ext.util.Format.stripTags(a)),d.test(a)&&(a=a.replace(d," ")),b.test(a)&&(a=a.replace(/\"/g,'""'),a=Ext.String.format('"{0}"',a)),a},getCellData:function(a,b,c,d,e){if(!a||!a.dataIndex)return null;var f=null;if(a.relativeType||(f=b[a.dataIndex]),"Feature"===a.relativeType){var g=b[this.getFeatureName()].ObjectID;f=d[g]&&d[g][a.dataIndex]}if("Initiative"===a.relativeType){var g=b[this.getFeatureName()].ObjectID,h=d[g],i=h&&h.Parent&&h.Parent.ObjectID||null,j=i&&c[i];f=j&&j[a.dataIndex]}if("TestCases"===a.relativeType){var k=e[b.ObjectID];k&&k.length>0&&(f=_.pluck(k,a.dataIndex),f=f.join("\n"))}return Ext.isObject(f)&&(f=f._refObjectName||f.Name),this.scrubCell(f)},getInitiativeFetch:function(){var a=["ObjectID","FormattedID"];return Ext.Array.each(this.extractFields,function(b){"Initiative"===b.relativeType&&a.push(b.dataIndex)}),a},getFeatureFetch:function(){var a=["ObjectID","FormattedID","Parent"];return Ext.Array.each(this.extractFields,function(b){"Feature"===b.relativeType&&a.push(b.dataIndex)}),a},getStoryFetch:function(){var a=["ObjectID","FormattedID","TestCases",this.getFeatureName()];return Ext.Array.each(this.extractFields,function(b){b.relativeType||a.push(b.dataIndex)}),a},getTestCaseFetch:function(){var a=["ObjectID","FormattedID","Name","LastVerdict","WorkProduct"];return Ext.Array.each(this.extractFields,function(b){"TestCases"===b.relativeType&&a.push(b.dataIndex)}),a},getInitiativeObjectID:function(){return this.initiativeObjectID},getFeatureName:function(){return this.portfolioItemTypes[0].replace("PortfolioItem/","")},getInitiativeConfig:function(){return{model:this.portfolioItemTypes[1],fetch:this.getInitiativeFetch(),filters:[{property:"ObjectID",value:this.getInitiativeObjectID()}]}},getFeatureConfig:function(){return{model:this.portfolioItemTypes[0],fetch:this.getFeatureFetch(),filters:[{property:"Parent.ObjectID",value:this.getInitiativeObjectID()}]}},getStoryConfig:function(){var a=this.getFeatureName();return{model:"HierarchicalRequirement",fetch:this.getStoryFetch(),filters:[{property:a+".Parent.ObjectID",value:this.getInitiativeObjectID()}]}},getTestCaseConfig:function(a){for(var b=[],c=0;c<a.length;c++)a[c].get("TestCases")&&a[c].get("TestCases").Count>0&&b.push({property:"WorkProduct.ObjectID",value:a[c].get("ObjectID")});return b&&b.length>1&&(b=Rally.data.wsapi.Filter.or(b)),{model:"TestCase",fetch:this.getTestCaseFetch(),filters:b,enablePostGet:!0}}}),Ext.define("RallyTechServices.RequirementsTracabilityMatrix.utils.exporter",{mixins:{observable:"Ext.util.Observable"},constructor:function(a){this.mixins.observable.constructor.call(this,a),this.exportConfig=a.exportConfig},doExport:function(){this.initiatives=[],this.features=[],this.stories=[],this.testCases=[],this.fetchInitiative().then({success:this.fetchFeatures,failure:this.showErrorNotification,scope:this}).then({success:this.fetchStories,failure:this.showErrorNotification,scope:this}).then({success:this.fetchTestCases,failure:this.showErrorNotification,scope:this}).then({success:this.processCSV,failure:this.showErrorNotification,scope:this})},showErrorNotification:function(a){this.fireEvent("doexporterror",a)},fetchInitiative:function(){return this._fetchWsapiRecords(this.exportConfig.getInitiativeConfig())},fetchFeatures:function(a){return this.initiatives=a,this.fireEvent("doexportupdate","Fetching Portfolio Items..."),this._fetchWsapiRecords(this.exportConfig.getFeatureConfig(a))},fetchStories:function(a){return this.features=a,this.fireEvent("doexportupdate","Fetching User Stories..."),this._fetchWsapiRecords(this.exportConfig.getStoryConfig(a))},fetchTestCases:function(a){return this.stories=a,this.fireEvent("doexportupdate",Ext.String.format("Fetching Test Cases for {0} User Stories...",a.length)),this._fetchWsapiRecords(this.exportConfig.getTestCaseConfig(a))},processCSV:function(a){this.testCases=a;var b=this.exportConfig.transformRecordsToExtract(this.initiatives,this.features,this.stories,this.testCases);this.fireEvent("doexportcomplete",b)},_fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred");return a.limit||(a.limit="Infinity"),Ext.create("Rally.data.wsapi.Store",a).load({callback:function(c,d){d.wasSuccessful()?b.resolve(c):b.reject(Ext.String.format("Error loading [{0}] records: {1}",a.model,d&&d.error&&d.error.errors.join("<br/>")))}}),b.promise}}),Ext.define("requirements-traceability-matrix",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},integrationHeaders:{name:"requirements-traceability-matrix"},defaultView:[{text:"Contract ID",dataIndex:"Name",relativeType:"Initiative"},{text:"Contract Citation",dataIndex:"FormattedID",relativeType:"Feature"},{text:"User Story",dataIndex:"FormattedID"},{text:"Contract Requirement",dataIndex:"Description"},{text:"Contractor Approach",dataIndex:"Notes"},{text:"Related Test Cases",dataIndex:"Name",relativeType:"TestCases"},{text:"Test Case Results",dataIndex:"LastVerdict",relativeType:"TestCases"}],portfolioItemTypes:["PortfolioItem/Feature","PortfolioItem/Initiative"],launch:function(){this._addComponents()},_addComponents:function(){this.removeAll();var a=this.add({xtype:"container",layout:"hbox",itemId:"execution_box",padding:5}),b=a.add({xtype:"rallycombobox",storeConfig:{model:this.portfolioItemTypes[1],fetch:["FormattedID","ObjectID","Name"],remoteFilter:!1,autoLoad:!0,limit:1/0},fieldLabel:this.getInitiativeName(),labelAlign:"right",allowNoEntry:!1,noEntryText:"",noEntryValue:0,itemId:"cbPortfolioItem",margin:10,valueField:"ObjectID",displayField:"FormattedID",width:600,listConfig:{itemTpl:'<tpl if="ObjectID &gt; 0">{FormattedID}: {Name}</tpl>'},filterProperties:["Name","FormattedID","ObjectID"],fieldCls:"pi-selector",displayTpl:'<tpl for="."><tpl if="ObjectID &gt; 0 ">{[values["FormattedID"]]}: {[values["Name"]]}</tpl><tpl if="xindex < xcount">,</tpl></tpl>'});b.on("select",this.enableExportButton,this);var c=a.add({xtype:"rallycombobox",itemId:"cbView",fieldLabel:"Select View",labelAlign:"right",width:250,store:this.getViewStore(),displayField:"viewName",valueField:"viewObj",editable:!1,margin:5});c.on("select",this.updateView,this);var d=a.add({xtype:"rallybutton",iconCls:"icon-export",itemId:"btExport",cls:"rly-small primary",disabled:!0,margin:5});d.on("click",this._exportData,this)},getInitiativeName:function(){return this.portfolioItemTypes[1].replace("PortfolioItem/","")},getFeatureName:function(){return this.portfolioItemTypes[0].replace("PortfolioItem/","")},enableExportButton:function(){var a=this.down("#cbPortfolioItem")&&this.down("#cbPortfolioItem").getValue()&&this.down("#cbView")&&this.down("#cbView").getValue()?!0:!1;this.down("#btExport")&&this.down("#btExport").setDisabled(!a)},updateView:function(a){this.enableExportButton(),this.down("#gridView")&&this.down("#gridView").destroy();var b=a.getValue()||null;if(b){var c=Ext.create("Rally.data.custom.Store",{data:[{name:this.getInitiativeName(),value:"Initiative"},{name:this.getFeatureName(),value:"Feature"},{name:"TestCases",value:"TestCases"}],fields:["name","value"]});this.add({xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:b,fields:["text","dataIndex","relativeType"],pageSize:b.length}),columnCfgs:[{dataIndex:"text",text:"Column Name",flex:1,editor:{xtype:"rallytextfield"}},{dataIndex:"relativeType",text:"Related Object Type",renderer:function(a,b,c){return a?a:"-- None --"},flex:1,editor:{xtype:"rallycombobox",store:c,displayField:"name",valueField:"value",allowNoEntry:!0,noEntryText:"-- None --"}},{dataIndex:"dataIndex",text:"Field Mapping",flex:1,editor:{xtype:"rallyfieldcombobox",model:"hierarchicalrequirement"}}],showRowActionsColumn:!1,showPagingToolbar:!1})}},getViewStore:function(){return Ext.create("Rally.data.custom.Store",{data:[{viewName:"Default",viewObj:this.defaultView}],fields:["viewName","viewObj"]})},getSelectedInitiativeObjectID:function(){return this.down("#cbPortfolioItem")&&this.down("#cbPortfolioItem").getValue()||null},getSelectedExtractFields:function(){return this.down("#cbView").getValue()},getExportConfig:function(){return Ext.create("RallyTechServices.RequirementsTracabilityMatrix.utils.exportConfiguration",{portfolioItemTypes:this.portfolioItemTypes,initiativeObjectID:this.getSelectedInitiativeObjectID(),extractFields:this.getSelectedExtractFields()})},_exportData:function(){var a=this.getExportConfig();this.logger.log("_exportData",a);var b=Ext.create("RallyTechServices.RequirementsTracabilityMatrix.utils.exporter",{exportConfig:a,listeners:{scope:this,doexporterror:this.showErrorNotification,doexportupdate:this.showUpdateNotification,doexportcomplete:this.saveExportFile}});b.doExport()},saveExportFile:function(a){Rally.ui.notify.Notifier.hide({}),this.logger.log("saveExportFile",a);var b=Ext.String.format("tracability-matrix-{0}.csv",Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s"));this.saveCSVToFile(a,b)},showErrorNotification:function(a){Rally.ui.notify.Notifier.hide(),this.logger.log("showErrorNotification",a),Rally.ui.notify.Notifier.showError({message:a})},showUpdateNotification:function(a){this.logger.log("showUpdateNotification",a),Rally.ui.notify.Notifier.show({message:a})},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):window.webkitURL?window.webkitURL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}});
            
               Rally.launchApp('requirements-traceability-matrix', {
                   name: 'Requirements Traceability Matrix'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>